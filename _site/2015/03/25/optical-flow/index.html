<!DOCTYPE html>
<html>

  <head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Optical Flow Estimation With Horn-Schunck Method</title>
	<meta name="description" content="">
	
	<link rel="canonical" href="http://www.mae.cuhk.edu.hk/~fzheng/~fzheng/2015/03/25/optical-flow/">
	<link rel="alternate" type="application/rss+xml" title="Fan's Farm" href="http://www.mae.cuhk.edu.hk/~fzheng/~fzheng/feed.xml" />
	
	<!-- <link rel="stylesheet" href="/~fzheng/css/main.css"> -->

	<link rel="stylesheet" type="text/css" href="http://apps.bdimg.com/libs/bootstrap/3.3.0/css/bootstrap.min.css">
	<!-- <link rel="stylesheet" type="text/css" href="http://apps.bdimg.com/libs/fontawesome/4.2.0/css/font-awesome.min.css"> -->
	<!-- <link rel="stylesheet" type="text/css" href="/~fzheng/static/css/bootstrap.min.css"> -->
	

	<link rel="stylesheet" type="text/css" href="/~fzheng/static/css/index.css">
	
	<!-- <script type="text/javascript" src="/~fzheng/static/js/jquery-1.11.1.min.js"></script>
	<script type="text/javascript" src="/~fzheng/static/js/bootstrap.min.js"></script> -->

	<script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>
	<script type="text/javascript" src="http://apps.bdimg.com/libs/bootstrap/3.3.0/js/bootstrap.min.js"></script>

	<script type="text/javascript" src="/~fzheng/static/js/index.js"></script>
	
	<link rel="stylesheet" type="text/css" href="http://apps.bdimg.com/libs/highlight.js/8.4/styles/monokai_sublime.min.css">
	<!-- <link rel="stylesheet" type="text/css" href="http://apps.bdimg.com/libs/highlight.js/8.4/styles/railscasts.min.css"> -->
	<!-- <link rel="stylesheet" type="text/css" href="http://apps.bdimg.com/libs/highlight.js/8.4/styles/monokai.min.css"> -->
	<!-- <script type="text/javascript" src="http://apps.bdimg.com/libs/highlight.js/8.4/languages/dos.min.js"></script> -->
	<script type="text/javascript" src="http://apps.bdimg.com/libs/highlight.js/8.4/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>

	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?b636473d6ffa17615f94e5db1459ea81";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>

</head>

  <body>
    <div id="main" class="container main">
       <div  class="row">
   
   <div class="col-sm-1">
        <div id="left-bar">
          <p><a href="/~fzheng/">Home</a></p>
            
            
              <p><a href="/~fzheng/blog/">Blog</a></p>
    
            
              
            
              
                
                
                <p><a href="/~fzheng/archive/"> Archive</a></p>
              
            
              
                
                
                <p><a href="/~fzheng/about/"> About</a></p>
              
            
              
            
              
            
        </div>
    </div>

  <div class="col-sm-8 col-sm-offset-1">
    <div class="post-area post">
      <header>
        <h1>Optical Flow Estimation With Horn-Schunck Method</h1>
        <p>Mar 25, 2015</p>
        <p>
          
          <a>#computer_vision</a>
          
        </p>
      </header>
      <article>
        <ul id="markdown-toc">
  <li><a href="#download-code" id="markdown-toc-download-code">Download Code</a></li>
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li>
  <li><a href="#horn-schunck-method" id="markdown-toc-horn-schunck-method">Horn-Schunck Method</a></li>
  <li><a href="#variational-framework" id="markdown-toc-variational-framework">Variational Framework</a></li>
  <li><a href="#optimization" id="markdown-toc-optimization">Optimization</a></li>
  <li><a href="#evaluation" id="markdown-toc-evaluation">Evaluation</a></li>
  <li><a href="#algorithm-flowchart" id="markdown-toc-algorithm-flowchart">Algorithm Flowchart</a></li>
  <li><a href="#experimental-results" id="markdown-toc-experimental-results">Experimental Results</a></li>
</ul>

<h3 id="download-code">Download Code</h3>

<p><a href="https://github.com/izhengfan/opticalflow">Click here.</a></p>

<h3 id="introduction">Introduction</h3>

<p>Estimating the motion of every pixel in a sequence of images is a problem with many applications in computer vision, such as image segmentation, object classification, and driver assistance.</p>

<p>In general, optical flow describes a dense vector field, where a displacement vector is assigned to each pixel, which points to where that pixel can be found in another image. An example is shown as below.</p>

<p><img src="/~fzheng/images/cvproject/floweg.jpg" width="100%" /></p>

<p>This project is a solution for Assignment 3 Optical Flow Estimation of the course Image Processing and Computer Vision (ENGG 5104, CUHK, 2015 Spring). In this project, I implement an algorithm solving the optical flow map (u,v) between two image frames using Horn-Schunck Method.</p>

<h3 id="horn-schunck-method">Horn-Schunck Method</h3>

<p>Horn-Schunck method is a classical optical flow estimation algorithm. It assumes smoothness in the flow over the whole image. Thus, it tries to minimize distortions in flow and prefers solutions which show more smoothness. In this assignment, we will implement the modern version of Horn-Schunck method, using pyramid-based coarse-to-fine scheme to achieve better performance, similar to that of Lucas-Kanade method. Many current optical flow algorithms are built upon its framework.</p>

<p>The objective is formulated as a global energy functional which is then minimized. Let the image be p = (x,y) and the underlying flow field be w(p) = (u(p),v(p), 1), where u(p) and v(p) are the horizontal and vertical components of the flow field, respectively. Under the brightness constancy assumption, the pixel value should be consistent along the flow vector, and the flow field should be piecewise smooth. This results in an objective function in the continuous spatial domain</p>

<p><img class="img-responsive" src="/~fzheng/images/cvproject/eq1.jpg" /></p>

<p>where ∇ is the gradient operator, λ weights the regularization, I1 and I2 are two corresponding images.</p>

<h3 id="variational-framework">Variational Framework</h3>

<p>To solve Eq. (1), we use an iterative flow framework. It assumes that an estimate of the flow field is w, and one needs to estimate the best increment dw(dw=(du,dv)), to update w. The objective function in Eq. (1) is then changed to</p>

<p><img class="img-responsive" src="/~fzheng/images/cvproject/eq2.jpg" /></p>

<p>Let</p>

<p><img class="img-responsive" src="/~fzheng/images/cvproject/eq3.jpg" /></p>

<p>With first-order Taylor expansion:</p>

<p><img class="img-responsive" src="/~fzheng/images/cvproject/eq4.jpg" /></p>

<p>In the above equation we add variable p into du and dv to index du and dv in images.</p>

<p>For easy computation, we vectorize u, v, du, dv into U, V, dU, dV, and Dx, Dy to denote derivative filters in x and y direction. The continuous function E(du,dv)in Eq. (2) can be discretized as E(dU,dV).</p>

<h3 id="optimization">Optimization</h3>

<p>The main idea to solve the above equation is to find dU,dV so that the gradient</p>

<p><img src="/~fzheng/images/cvproject/eq5.jpg" width="20%" /></p>

<p>We can derive</p>

<p><img class="img-responsive" src="/~fzheng/images/cvproject/eq6.jpg" /></p>

<p>L is a Laplacian filter defined as</p>

<p><img class="img-responsive" src="/~fzheng/images/cvproject/eq7.jpg" /></p>

<p>The term of dU in gradient is derived similarly. Therefore, solving the gradient equation can be performed in the following linear system</p>

<p> <img class="img-responsive" src="/~fzheng/images/cvproject/eq8.jpg" /></p>

<h3 id="evaluation">Evaluation</h3>

<p>Having built the pyramids and solve Eq. (8) in each level iteratively, the result in the finest level is obtained. We evaluate optical flow results by two measures: Average Angle Error (AAE) and End Point Error (EPE). They are defined by comparing flow result with the ground truth flow. The lower the AAE and EPE are, the better the optical flow performance is. Also we can visually estimate your result from visualization of the flow map (using flowToColor function).</p>

<h3 id="algorithm-flowchart">Algorithm Flowchart</h3>
<pre><code>Input: frame1,frame2,λ
Build image pyramid;
Initialize flow = 0;
For i= numPyramidLevel:1
   Initialize flow from previous level;
   Build gradient matrix and Laplacian matrix;
   For j=1:maxWarpingNum
      Warp image using flow vector;
      Compute image gradient Ix, Iy, and Iz;
      Build linear system to solve HS flow;
      Solve linear system to compute the flow;
      Use median filter to smooth the flow map;
    EndFor
EndFor
Output: flow
</code></pre>

<h3 id="experimental-results">Experimental Results</h3>

<p>For experimental process, refer to my <a href="https://github.com/izhengfan/opticalflow">Github project</a>.</p>

<p>Five pairs of images are tested, the results as execution time are shown below:</p>

<p><img src="/~fzheng/images/cvproject/Grove2.jpg" width="100%" /></p>
<p><center><img class="img-responsive" src="/~fzheng/images/cvproject/Grove2time.jpg" /></center></p>

<p>Evaluation measure of picture above: AAE 9.669 average EPE 1.010.<br /><br /></p>

<p><img src="/~fzheng/images/cvproject/Hydrangea.jpg" width="100%" /><p>
<p><center><img class="img-responsive" src="/~fzheng/images/cvproject/Hydrangeatime.jpg" /></center></p>

Evaluation measure of picture above: AAE 4.901 average EPE 0.456.<br /><br />

<p><img src="/~fzheng/images/cvproject/RubberWhale.jpg" width="100%" /></p>
<p><center>
<img class="img-responsive" src="/~fzheng/images/cvproject/RubberWhaletime.jpg" /></center></p>

Evaluation measure of picture above: AAE 9.812 average EPE 0.297.<br /><br />

<p><img src="/~fzheng/images/cvproject/Dimetrodon.jpg" width="100%" /></p>
<p><center>
<img class="img-responsive" src="/~fzheng/images/cvproject/Dimetrodontime.jpg" /></center></p>

Evaluation measure of picture above: AAE 4.673 average EPE 0.250.<br /><br />

<p><img src="/~fzheng/images/cvproject/Urban3.jpg" width="100%" /></p>
<p><center>
<img class="img-responsive" src="/~fzheng/images/cvproject/Urban3time.jpg" /></center></p>

Evaluation measure of picture above: AAE 12.257 average EPE 1.312.<br /><br />


Some regions in the image groups with visible changes are circled to show that the Warped Image is more similar to frame 1 than frame 2, which indicates that the estimated optical flow is considerately accurate, since the the Warped Image representing frame2 warped to frame1 accroding to the estimated optical flow.
</p></p>

      </article>
    </div>
    <div id="disqus_thread"></div>
  </div>
      

  <div id="content" class="col-sm-2">
    <div id="myAffix" class="shadow-bottom-center hidden-xs" >
      <div class="categories-list-header">
        Content
      </div>
      <div class="content-text"></div>
    </div>
  </div>

</div>



    </div>

    <a id="top"></a>

    <!--<div id="disqus_thread"></div>-->
    <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES * * */
      var disqus_shortname = 'fansfarm';
      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    
    
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'fansfarm';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
  
  
  </body>
</html>



